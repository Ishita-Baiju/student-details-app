<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Details App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; background:#f7fafc; color:#111827 }
    .card { background:white; padding:16px; border-radius:12px; box-shadow:0 6px 20px rgba(2,6,23,.07); max-width:980px; margin:0 auto }
    input, select, button { padding:8px; border-radius:8px; border:1px solid #e6edf3 }
    table { width:100%; border-collapse:collapse; margin-top:12px }
    th,td { padding:8px; border-bottom:1px solid #eef2f6 }
    th { text-align:left; background:#f1f5f9 }
    .right { text-align:right }
    .muted { font-size:13px; color:#6b7280 }
  </style>
</head>
<body>
  <div class="card">
    <h2>Student Details (CSV Import)</h2>
    <p class="muted">Upload a CSV file with student details to add multiple students at once. Required headers: <b>scholarNo,name,fatherName,motherName,dob,class,category,nicId,mobile</b>.</p>

    <input type="file" id="csvFileInput" accept=".csv" />
    <button id="uploadCsvBtn">Upload CSV</button>

    <table>
      <thead>
        <tr>
          <th>Scholar No</th>
          <th>Name</th>
          <th>Father</th>
          <th>Mother</th>
          <th>DOB</th>
          <th>Class</th>
          <th>Category</th>
          <th>NIC ID</th>
          <th>Mobile</th>
        </tr>
      </thead>
      <tbody id="studentsTbody"></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Use the same Firebase project as your marks app (or replace with another project's config)
    const firebaseConfig = {
      apiKey: "AIzaSyB6lJ0qAoiFY72MKtzcTFCdVBaOv5-vqtA",
      authDomain: "student-marks-app-dc6c3.firebaseapp.com",
      projectId: "student-marks-app-dc6c3",
      storageBucket: "student-marks-app-dc6c3.firebasestorage.app",
      messagingSenderId: "412370498316",
      appId: "1:412370498316:web:3cd36ec52d5be3eb524f29",
      measurementId: "G-EC3WCXXFS9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (u) => {});
    try { await signInAnonymously(auth); } catch(e){ console.error('auth',e); }

    // UI
    const form = document.getElementById('studentForm');
    const s_rollNo = document.getElementById('s_rollNo');
    const s_name = document.getElementById('s_name');
    const s_class = document.getElementById('s_class');
    const s_section = document.getElementById('s_section');
    const s_dob = document.getElementById('s_dob');
    const s_parent = document.getElementById('s_parent');
    const studentsTbody = document.getElementById('studentsTbody');
    const addStudentBtn = document.getElementById('addStudentBtn');
    const resetStudentBtn = document.getElementById('resetStudentBtn');

    // CSV UI
    const fileInput = document.getElementById('csvFile');
    const previewTbody = document.getElementById('csvPreviewTbody');
    const importBtn = document.getElementById('importCsvBtn');
    const downloadTemplate = document.getElementById('downloadTemplate');

    let students = [];
    let editStudentId = null;
    let csvRows = []; // parsed rows ready to import

    function enterEdit(student){
      editStudentId = student.id;
      s_rollNo.value = student.rollNo || '';
      s_name.value = student.name || '';
      s_class.value = student.studentClass || '';
      s_section.value = student.section || '';
      s_dob.value = student.dob || '';
      s_parent.value = student.parentContact || '';
      addStudentBtn.textContent = 'Update Student';
      resetStudentBtn.textContent = 'Cancel Edit';
      s_rollNo.focus();
    }

    function exitEdit(){
      editStudentId = null;
      form.reset();
      addStudentBtn.textContent = 'Add Student';
      resetStudentBtn.textContent = 'Reset';
      s_rollNo.focus();
    }

    function renderStudents(){
      studentsTbody.innerHTML = '';
      for (const s of students){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.rollNo || ''}</td>
          <td>${s.name || ''}</td>
          <td>${s.studentClass || ''}</td>
          <td>${s.section || ''}</td>
          <td>${s.dob || ''}</td>
          <td>${s.parentContact || ''}</td>
          <td class="right" style="white-space:nowrap;">
            <button data-action="edit" data-id="${s.id}">Edit</button>
            <button data-action="delete" data-id="${s.id}">Delete</button>
          </td>`;
        studentsTbody.appendChild(tr);
      }
    }

    // Listen to students collection
    const studentsCol = collection(db, 'students');
    onSnapshot(query(studentsCol, orderBy('rollNo')), (snap) => {
      students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderStudents();
    });

    // Add / Update handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        rollNo: (s_rollNo.value||'').toString().trim(),
        name: (s_name.value||'').toString().trim(),
        studentClass: (s_class.value||'').toString().trim(),
        section: (s_section.value||'').toString().trim(),
        dob: s_dob.value || '',
        parentContact: (s_parent.value||'').toString().trim()
      };

      if (!payload.rollNo || !payload.name || !payload.studentClass) { alert('Please fill Roll No, Name and Class'); return; }

      try {
        if (editStudentId) {
          await updateDoc(doc(db, 'students', editStudentId), { ...payload, updatedAt: serverTimestamp() });
          exitEdit();
        } else {
          await addDoc(studentsCol, { ...payload, createdAt: serverTimestamp() });
          form.reset();
        }
      } catch (err) { console.error(err); alert('Error saving student. Check console.'); }
    });

    // Reset / Cancel
    resetStudentBtn.addEventListener('click', () => { if (editStudentId) exitEdit(); else form.reset(); });

    // Row actions
    studentsTbody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.dataset.id; const action = btn.dataset.action;
      if (action === 'delete') {
        if (confirm('Delete this student?')) {
          try { await deleteDoc(doc(db, 'students', id)); } catch (err) { console.error(err); alert('Delete failed.'); }
        }
      } else if (action === 'edit') {
        const s = students.find(x => x.id === id); if (s) enterEdit(s);
      }
    });

    // ---------------- CSV Import Helpers ----------------
    // Simple CSV parser that handles quoted fields
    function parseCSV(text) {
      const rows = [];
      let cur = '';
      let row = [];
      let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (ch === '"') {
          if (inQuotes && text[i+1] === '"') { cur += '"'; i++; }
          else inQuotes = !inQuotes;
        } else if (ch === ',' && !inQuotes) {
          row.push(cur); cur = '';
        } else if ((ch === '
' || ch === '
') && !inQuotes) {
          // handle CRLF
          if (cur !== '' || row.length) { row.push(cur); cur = ''; }
          if (row.length) { rows.push(row); row = []; }
          // skip following LF in CRLF
          if (ch === '
' && text[i+1] === '
') i++; 
        } else {
          cur += ch;
        }
      }
      if (cur !== '' || row.length) { row.push(cur); rows.push(row); }
      return rows;
    }

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const text = ev.target.result;
        const rowsParsed = parseCSV(text);
        if (!rowsParsed.length) return alert('CSV appears empty');

        const headers = rowsParsed[0].map(h => h.trim());
        const expected = ['scholar_no','name','father_name','mother_name','dob','class','section','category','nic_id','mobile_no'];
        // show warning if headers don't match exactly but still try to map by name
        const headerMap = {};
        headers.forEach((h,i) => headerMap[h.toLowerCase()] = i);

        csvRows = [];
        previewTbody.innerHTML = '';
        for (let r = 1; r < rowsParsed.length; r++) {
          const row = rowsParsed[r];
          if (row.length === 1 && row[0].trim() === '') continue; // skip empty lines
          const obj = {
            scholarNo: (row[headerMap['scholar_no']] || '').trim(),
            name: (row[headerMap['name']] || '').trim(),
            fatherName: (row[headerMap['father_name']] || '').trim(),
            motherName: (row[headerMap['mother_name']] || '').trim(),
            dob: (row[headerMap['dob']] || '').trim(),
            studentClass: (row[headerMap['class']] || '').trim(),
            section: (row[headerMap['section']] || '').trim(),
            category: (row[headerMap['category']] || '').trim(),
            nicId: (row[headerMap['nic_id']] || '').trim(),
            mobileNo: (row[headerMap['mobile_no']] || '').trim()
          };
          csvRows.push(obj);

          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${obj.scholarNo}</td><td>${obj.name}</td><td>${obj.fatherName}</td><td>${obj.motherName}</td><td>${obj.dob}</td><td>${obj.studentClass}</td><td>${obj.category}</td><td>${obj.nicId}</td><td>${obj.mobileNo}</td>`;
          previewTbody.appendChild(tr);
        }

        if (!csvRows.length) alert('No valid rows found in CSV');
      };
      reader.readAsText(file);
    });

    // Download CSV template
    downloadTemplate.addEventListener('click', (e) => {
      e.preventDefault();
      const headers = ['scholar_no','name','father_name','mother_name','dob','class','section','category','nic_id','mobile_no'];
      const example = ['101','Rahul Sharma','Ajay Sharma','Sunita Sharma','2010-05-12','10A','A','General','ABCDE1234','9876543210'];
      const csv = headers.join(',') + '
' + example.join(',');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'students_template.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // Import CSV rows into Firestore
    importBtn.addEventListener('click', async () => {
      if (!csvRows.length) return alert('No CSV rows to import.');
      if (!confirm(`Import ${csvRows.length} students to Firestore?`)) return;

      importBtn.disabled = true;
      let imported = 0;
      for (const r of csvRows) {
        const payload = {
          scholarNo: r.scholarNo || '',
          rollNo: r.scholarNo || '',
          name: r.name || '',
          fatherName: r.fatherName || '',
          motherName: r.motherName || '',
          dob: r.dob || '',
          studentClass: r.studentClass || '',
          section: r.section || '',
          category: r.category || '',
          nicId: r.nicId || '',
          mobileNo: r.mobileNo || '',
          parentContact: r.mobileNo || '',
          createdAt: serverTimestamp()
        };
        try {
          await addDoc(studentsCol, payload);
          imported++;
        } catch (err) {
          console.error('Import row failed', r, err);
        }
      }
      importBtn.disabled = false;
      alert(`Imported ${imported} of ${csvRows.length} students.`);
      // clear preview
      csvRows = [];
      previewTbody.innerHTML = '';
      fileInput.value = '';
    });
  </script>
</body>
</html>
