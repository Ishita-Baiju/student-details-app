<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Marks App</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB6lJ0qAoiFY72MKtzcTFCdVBaOv5-vqtA",
      authDomain: "student-marks-app-dc6c3.firebaseapp.com",
      projectId: "student-marks-app-dc6c3",
      storageBucket: "student-marks-app-dc6c3.firebasestorage.app",
      messagingSenderId: "412370498316",
      appId: "1:412370498316:web:3cd36ec52d5be3eb524f29",
      measurementId: "G-EC3WCXXFS9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Sign in anonymously
    signInAnonymously(auth).catch(console.error);

    const marksCol = collection(db, 'marks');
    const studentsCol = collection(db, 'students');

    const form = document.getElementById('marksForm');
    const studentSelect = document.getElementById('studentSelect');
    const rollNo = document.getElementById('rollNo');
    const nameEl = document.getElementById('name');
    const studentClass = document.getElementById('studentClass');
    const subject = document.getElementById('subject');
    const marks = document.getElementById('marks');
    const tableBody = document.getElementById('marksTableBody');

    let editingId = null;
    let students = [];

    // Fetch students live
    onSnapshot(query(studentsCol, orderBy('rollNo')), (snap) => {
      students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      populateStudentSelect();
    });

    function populateStudentSelect() {
      studentSelect.innerHTML = '<option value="">-- Select Student --</option>';
      students.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = `${s.rollNo} â€” ${s.name} (${s.studentClass})`;
        opt.dataset.roll = s.rollNo;
        opt.dataset.name = s.name;
        opt.dataset.class = s.studentClass;
        studentSelect.appendChild(opt);
      });
    }

    studentSelect.addEventListener('change', () => {
      const id = studentSelect.value;
      if (!id) return;
      const opt = studentSelect.selectedOptions[0];
      rollNo.value = opt.dataset.roll || '';
      nameEl.value = opt.dataset.name || '';
      studentClass.value = opt.dataset.class || '';
    });

    function getStudentDetailsById(id) {
      return students.find(s => s.id === id) || {};
    }

    // Add or update marks
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const docData = {
        rollNo: rollNo.value,
        name: nameEl.value,
        studentClass: studentClass.value,
        subject: subject.value,
        marks: marks.value,
        studentId: studentSelect.value || null, // link to students collection
        updatedAt: serverTimestamp(),
        createdBy: auth.currentUser?.uid || null
      };

      try {
        if (editingId) {
          await updateDoc(doc(db, 'marks', editingId), docData);
          editingId = null;
        } else {
          await addDoc(marksCol, { ...docData, createdAt: serverTimestamp() });
        }
        form.reset();
        studentSelect.value = '';
      } catch (err) {
        console.error('Error adding/updating marks:', err);
      }
    });

    // Display marks live
    onSnapshot(query(marksCol, orderBy('createdAt', 'desc')), (snap) => {
      tableBody.innerHTML = '';
      snap.forEach(docSnap => {
        const d = docSnap.data();
        const student = getStudentDetailsById(d.studentId);
        const roll = student.rollNo || d.rollNo;
        const name = student.name || d.name;
        const cls = student.studentClass || d.studentClass;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${roll}</td>
          <td>${name}</td>
          <td>${cls}</td>
          <td>${d.subject}</td>
          <td>${d.marks}</td>
          <td>
            <button onclick="editMark('${docSnap.id}', '${roll}', '${name}', '${cls}', '${d.subject}', '${d.marks}', '${d.studentId || ''}')">Edit</button>
            <button onclick="deleteMark('${docSnap.id}')">Delete</button>
          </td>`;
        tableBody.appendChild(tr);
      });
    });

    // Expose edit/delete
    window.editMark = (id, roll, name, cls, subj, mark, sid) => {
      editingId = id;
      rollNo.value = roll;
      nameEl.value = name;
      studentClass.value = cls;
      subject.value = subj;
      marks.value = mark;
      studentSelect.value = sid || '';
    };

    window.deleteMark = async (id) => {
      if (confirm('Delete this record?')) {
        await deleteDoc(doc(db, 'marks', id));
      }
    };
  </script>
</head>
<body>
  <h1>Student Marks App</h1>
  <form id="marksForm">
    <label>Select Student:</label>
    <select id="studentSelect"></select><br>

    <label>Roll No:</label>
    <input id="rollNo" required><br>

    <label>Name:</label>
    <input id="name" required><br>

    <label>Class:</label>
    <input id="studentClass" required><br>

    <label>Subject:</label>
    <input id="subject" required><br>

    <label>Marks:</label>
    <input id="marks" required><br>

    <button type="submit">Save Marks</button>
  </form>

  <h2>Marks List</h2>
  <table border="1">
    <thead>
      <tr>
        <th>Roll No</th>
        <th>Name</th>
        <th>Class</th>
        <th>Subject</th>
        <th>Marks</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="marksTableBody"></tbody>
  </table>
</body>
</html>
