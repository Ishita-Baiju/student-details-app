<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Marks App</title>
</head>
<body>
  <h1>Student Marks</h1>

  <form id="marksForm">
    <select id="studentSelect" required></select>
    <input type="text" id="subject" placeholder="Subject" required>
    <input type="number" id="marks" placeholder="Marks" required>
    <button type="submit">Save</button>
  </form>

  <table border="1" width="100%">
    <thead>
      <tr>
        <th>Roll No</th>
        <th>Name</th>
        <th>Class</th>
        <th>Subject</th>
        <th>Marks</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="marksList"></tbody>
  </table>

  <!-- Student Marks Modal -->
  <div id="marksModal" style="display:none; position:fixed; top:0; left:0; 
    width:100%; height:100%; background:rgba(0,0,0,0.5);">
    <div style="background:#fff; padding:20px; max-width:600px; margin:50px auto; border-radius:8px;">
      <h2 id="modalStudentName">Student Marks</h2>
      <table border="1" width="100%">
        <thead>
          <tr>
            <th>Subject</th>
            <th>Marks</th>
          </tr>
        </thead>
        <tbody id="studentMarksTable"></tbody>
      </table>
      <br>
      <button onclick="closeModal()">Close</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB6lJ0qAoiFY72MKtzcTFCdVBaOv5-vqtA",
      authDomain: "student-marks-app-dc6c3.firebaseapp.com",
      projectId: "student-marks-app-dc6c3",
      storageBucket: "student-marks-app-dc6c3.firebasestorage.app",
      messagingSenderId: "412370498316",
      appId: "1:412370498316:web:3cd36ec52d5be3eb524f29",
      measurementId: "G-EC3WCXXFS9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const marksForm = document.getElementById("marksForm");
    const studentSelect = document.getElementById("studentSelect");
    const marksList = document.getElementById("marksList");

    let editId = null;
    let students = [];

    const studentsCol = collection(db, "students");
    onSnapshot(query(studentsCol, orderBy("rollNo")), (snap) => {
      students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      populateStudentSelect();
    });

    function populateStudentSelect() {
      studentSelect.innerHTML = "<option value='' disabled selected>Select Student</option>";
      students.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = `${s.rollNo} - ${s.name} (Class ${s.studentClass})`;
        studentSelect.appendChild(opt);
      });
    }

    function getStudentDetailsById(id) {
      return students.find(s => s.id === id) || {};
    }

    marksForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const studentId = studentSelect.value;
      const subject = document.getElementById("subject").value;
      const marks = document.getElementById("marks").value;

      if (!studentId) return alert("Please select a student");

      if (editId) {
        await updateDoc(doc(db, "marks", editId), { studentId, subject, marks });
        editId = null;
      } else {
        await addDoc(collection(db, "marks"), { studentId, subject, marks });
      }

      marksForm.reset();
      populateStudentSelect();
    });

    const marksCol = collection(db, "marks");
    onSnapshot(query(marksCol, orderBy("subject")), (snap) => {
      marksList.innerHTML = "";
      snap.forEach(docSnap => {
        const d = docSnap.data();
        const student = getStudentDetailsById(d.studentId);
        const roll = student.rollNo || "";
        const name = student.name || "";
        const cls = student.studentClass || "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${roll}</td>
          <td>${name}</td>
          <td>${cls}</td>
          <td>${d.subject}</td>
          <td>${d.marks}</td>
          <td>
            <button onclick="editMark('${docSnap.id}', '${d.studentId}', '${d.subject}', '${d.marks}')">Edit</button>
            <button onclick="deleteMark('${docSnap.id}')">Delete</button>
            <button onclick="viewMarks('${d.studentId}')">View Marks</button>
          </td>`;
        marksList.appendChild(tr);
      });
    });

    window.editMark = function(id, studentId, subject, marks) {
      editId = id;
      studentSelect.value = studentId;
      document.getElementById("subject").value = subject;
      document.getElementById("marks").value = marks;
    }

    window.deleteMark = async function(id) {
      if (confirm("Delete this record?")) {
        await deleteDoc(doc(db, "marks", id));
      }
    }

    window.viewMarks = async function(studentId) {
      const student = getStudentDetailsById(studentId);
      document.getElementById("modalStudentName").innerText =
        `${student.name || ""} (Class ${student.studentClass || ""}, Roll No: ${student.rollNo || ""})`;

      const q = query(marksCol, where("studentId", "==", studentId));
      const snap = await getDocs(q);

      const tbody = document.getElementById("studentMarksTable");
      tbody.innerHTML = "";

      if (snap.empty) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan=\"2\">No marks found</td>`;
        tbody.appendChild(tr);
      } else {
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${d.subject}</td><td>${d.marks}</td>`;
          tbody.appendChild(tr);
        });
      }

      document.getElementById("marksModal").style.display = "block";
    }

    window.closeModal = function() {
      document.getElementById("marksModal").style.display = "none";
    }
  </script>
</body>
</html>
